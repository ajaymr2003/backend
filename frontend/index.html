<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Car Simulation - Firestore</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f4f4; }
        .container { text-align: center; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background-color: white; width: 350px; }
        .user-section, .controls-section, .status-section { margin-bottom: 1.5rem; }
        input[type="email"] { padding: 0.5rem; width: 70%; margin-right: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 0.8rem 1.5rem; font-size: 1rem; cursor: pointer; border: none; border-radius: 4px; color: white; transition: background-color 0.3s, opacity 0.3s; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        #setUserBtn { background-color: #2196F3; } /* Blue */
        #startButton { background-color: #4CAF50; } /* Green */
        #stopButton { background-color: #f44336; } /* Red */
        #status { padding: 1rem; border: 1px solid #ddd; border-radius: 4px; background-color: #fafafa; }
        #status p { font-size: 1.2rem; margin: 0.5rem 0; }
        #batteryLevel { font-weight: bold; color: #008CBA; }
    </style>
</head>
<body>

    <div class="container">
        <h1>EV Car Simulation</h1>
        
        <div class="user-section">
            <h3>1. Set User</h3>
            <input type="email" id="emailInput" placeholder="Enter your email">
            <button id="setUserBtn">Set</button>
        </div>

        <div class="controls-section">
            <h3>2. Controls</h3>
            <button id="startButton" disabled>Start Car</button>
            <button id="stopButton" disabled>Stop Car</button>
        </div>

        <div id="status" class="status-section">
            <h3>Live Status</h3>
            <p><strong>User:</strong> <span id="currentUser">None</span></p>
            <p><strong>Status:</strong> <span id="runningStatus">Not Running</span></p>
            <p><strong>Battery:</strong> <span id="batteryLevel">100</span>%</p>
        </div>
    </div>

    <script>
        const emailInput = document.getElementById('emailInput');
        const setUserBtn = document.getElementById('setUserBtn');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const currentUserElem = document.getElementById('currentUser');
        const runningStatusElem = document.getElementById('runningStatus');
        const batteryLevelElem = document.getElementById('batteryLevel');

        const apiUrl = 'http://localhost:3000';
        let userEmail = null;
        let statusInterval = null;

        // --- UI Control ---
        function enableControls() {
            startButton.disabled = false;
            stopButton.disabled = false;
            emailInput.disabled = true;
            setUserBtn.disabled = true;
        }

        // --- Event Listeners ---
        setUserBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();
            if (email && email.includes('@')) {
                userEmail = email;
                currentUserElem.textContent = userEmail;
                enableControls();
                startPolling(); // Start polling for status once user is set
            } else {
                alert('Please enter a valid email address.');
            }
        });

        startButton.addEventListener('click', () => {
            fetch(`${apiUrl}/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: userEmail })
            })
            .then(res => res.json())
            .then(data => {
                console.log(data.message);
                if (data.message.includes('already running')) {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error starting car:', error));
        });

        stopButton.addEventListener('click', () => {
            fetch(`${apiUrl}/stop`, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: userEmail }) // Sending email is good practice
            })
            .catch(error => console.error('Error stopping car:', error));
        });

        // --- Live Status Polling ---
        const getStatus = () => {
            if (!userEmail) return; // Don't poll if no user is set

            fetch(`${apiUrl}/status`)
                .then(response => response.json())
                .then(data => {
                    // Only update if the status is for the current user
                    if (data.email === userEmail) {
                        runningStatusElem.textContent = data.isRunning ? 'Running' : 'Not Running';
                        batteryLevelElem.textContent = data.batteryLevel;
                    } else if (data.email === null) {
                        // If server car has no user, reflect that
                        runningStatusElem.textContent = 'Not Running';
                        batteryLevelElem.textContent = '100';
                    }
                })
                .catch(error => console.error('Error getting status:', error));
        };
        
        function startPolling() {
            if (statusInterval) clearInterval(statusInterval);
            getStatus(); // Get initial status immediately
            statusInterval = setInterval(getStatus, 1000);
        }
    </script>

</body>
</html>